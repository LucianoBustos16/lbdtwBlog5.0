---
import BrandLogo from "@/components/BrandLogo.astro"
import ThemeToggle from "./ThemeToggle.astro"
import Icon from "../icons/Icon.astro";

const { pathname } = Astro.url
const normalizedPathName = pathname.length > 1 && pathname.endsWith("/") ? pathname.slice(0, -1) : pathname

const pages = [
  { name: "Inicio", href: "/" },
  { name: "Blog", href: "/blog" },
  { name: "Estadisticas", href: "/statistics" },
  { name: "LBDTw Tv", href: "/lbdtwtv" }
].map(page => ({
  ...page,
  active: normalizedPathName === page.href || (page.href !== "/" && normalizedPathName.startsWith(page.href))
}))
---

<header class="sticky top-0 z-[100] h-16 lg:h-24 w-full bg-[var(--background-color)]/80 backdrop-blur-md">
  <div class="max-w-[1200px] flex justify-between mx-auto items-center h-full px-4">
    
    <a href="/" class="relative z-[110] flex items-center gap-2.5 font-bold transition-transform hover:scale-105">
      <BrandLogo class="text-primary h-auto w-8 md:w-12" />
      <span class="text-[10px] uppercase border px-1.5 py-0.5 rounded-full dark:text-gray-300 border-gray-800 dark:border-gray-300">Beta</span>
    </a>

    <nav class="flex items-center gap-4">
      <ul class="hidden lg:flex gap-8">
        {pages.map(({ name, href, active }) => (
          <li>
            <a href={href} class:list={["font-bold hover:text-primary transition-colors", { "text-primary": active }]}>
              {name}
            </a>
          </li>
        ))}
      </ul>

      <ThemeToggle />

      <button 
        id="menu-button" 
        class="relative z-[110] size-10 flex items-center justify-center lg:hidden bg-primary/10 rounded-full text-primary font-bold active:scale-95 transition-all"
        aria-expanded="false"
        aria-label="Menú"
      >
        <span id="icon-open" class="text-xl">
			<Icon icon="menu" size="24"/>			
		</span>
        <span id="icon-close" class="hidden text-xl">
			<Icon icon="close" size="24"/>	
		</span>
      </button>
    </nav>

    <div 
      id="mobile-menu" 
      class="fixed text-textDark dark:text-white inset-0 h-dvh w-full z-[100] hidden flex-col items-center justify-center bg-[var(--background-color)] opacity-0 transition-all duration-300 lg:hidden"
    >
      <ul class="flex flex-col items-center gap-8">
        {pages.map(({ name, href }) => (
          <li class="overflow-hidden">
            <a 
              href={href} 
              class="nav-link block  text-4xl font-black translate-y-full opacity-0 transition-all duration-500 ease-out uppercase hover:text-primary"
            >
              {name}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </div>
</header>

<style>
  /* Prevenir saltos de scroll al bloquear el body */
  :global(body.overflow-hidden) {
    overflow: hidden;
  }

  /* Asegurar que los links tengan una transición suave */
  .nav-link {
    transition: transform 0.5s ease-out, opacity 0.5s ease-out, color 0.3s ease;
  }
</style>

<script is:inline>
  function setupMenu() {
    const btn = document.getElementById('menu-button');
    const menu = document.getElementById('mobile-menu');
    const iconOpen = document.getElementById('icon-open');
    const iconClose = document.getElementById('icon-close');
    const links = document.querySelectorAll('.nav-link');

    if (!btn || !menu) return;

    // Limpiar estado por si acaso (evita bugs al navegar)
    const closeMenu = () => {
      btn.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('overflow-hidden');
      menu.style.opacity = '0';
      iconOpen.classList.remove('hidden');
      iconClose.classList.add('hidden');
      links.forEach(link => {
        link.style.transform = 'translateY(100%)';
        link.style.opacity = '0';
      });
      setTimeout(() => {
        menu.classList.add('hidden');
        menu.style.display = 'none';
      }, 300);
    };

    const openMenu = () => {
      btn.setAttribute('aria-expanded', 'true');
      document.body.classList.add('overflow-hidden');
      menu.classList.remove('hidden');
      menu.style.display = 'flex';
      iconOpen.classList.add('hidden');
      iconClose.classList.remove('hidden');

      // Pequeño delay para que el navegador procese el display: flex antes de la opacidad
      setTimeout(() => {
        menu.style.opacity = '1';
        links.forEach((link, i) => {
          setTimeout(() => {
            link.style.transform = 'translateY(0)';
            link.style.opacity = '1';
          }, i * 100);
        });
      }, 10);
    };

    btn.onclick = () => {
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      isExpanded ? closeMenu() : openMenu();
    };

    // Cerrar menú al clickear cualquier link
    links.forEach(link => {
      link.onclick = () => {
        if (window.innerWidth < 1024) closeMenu();
      };
    });
  }

  // Inicializar
  setupMenu();
  // Reinicializar cuando Astro cambie de página (View Transitions)
  document.addEventListener('astro:page-load', setupMenu);
</script>